_jsload&&_jsload('route', 'function RouteResult(opts){this["city"]=opts.city;this._start=opts.start;this._end=opts.end;this._plans=opts.plans;this["moreResultsUrl"]=opts.url;this["taxiFare"]=opts.taxiFare||null;this._startStatus=opts.startStatus||BMAP_ROUTE_STATUS_NORMAL;this._endStatus=opts.endStatus||BMAP_ROUTE_STATUS_NORMAL} baidu[Textend](RouteResult[Tprototype],{getStart:function(){return this._start},getEnd:function(){return this._end},getStartStatus:function(){return this._startStatus},getEndStatus:function(){return this._endStatus},getNumPlans:function(){return this._plans[Tlength]},getPlan:function(i){if(this._plans[i])return this._plans[i]}});function DrivingRouteResult(opts){RouteResult.call(this,opts);this["policy"]=opts.policy}baidu.inherits(DrivingRouteResult,RouteResult,"DrivingRouteResult"); function WalkingRouteResult(opts){RouteResult.call(this,opts)}baidu.inherits(WalkingRouteResult,RouteResult,"WalkingRouteResult");function TransitRouteResult(opts){RouteResult.call(this,opts);this["policy"]=opts.policy}baidu.inherits(TransitRouteResult,RouteResult,"TransitRouteResult");var RouteResultP=RouteResult[Tprototype]; exportSymbol(RouteResultP,{"getStart":RouteResultP.getStart,"getEnd":RouteResultP.getEnd,"getStartStatus":RouteResultP.getStartStatus,"getEndStatus":RouteResultP.getEndStatus,"getNumPlans":RouteResultP.getNumPlans,"getPlan":RouteResultP.getPlan});function RoutePlan(opts){this._routes=opts.routes.slice(0);this._distance=opts.distance||0;this._duration=opts.duration||0;this._dragPois=opts.dragPois||[]} baidu[Textend](RoutePlan[Tprototype],{getRoute:function(i){if(this._routes[i])return this._routes[i]},getNumRoutes:function(){return this._routes[Tlength]},getDistance:function(format){if(format===false)return this._distance;else return formatDistance(this._distance)},getDuration:function(format){if(format===false)return this._duration;else return formatTime(this._duration,"nav")},getDragPois:function(){return this._dragPois}});var RoutePlanP=RoutePlan[Tprototype]; exportSymbol(RoutePlanP,{"getNumRoutes":RoutePlanP.getNumRoutes,"getRoute":RoutePlanP.getRoute,"getDistance":RoutePlanP.getDistance,"getDuration":RoutePlanP.getDuration,"getDragPois":RoutePlanP.getDragPois});function TransitRoutePlan(opts){RoutePlan.call(this,opts);this._lines=opts.lines;this._description=opts.description;this._duration=opts.duration||0}baidu.inherits(TransitRoutePlan,RoutePlan,"TransitRoutePlan"); baidu[Textend](TransitRoutePlan[Tprototype],{getNumLines:function(){return this._lines[Tlength]},getLine:function(i){if(this._lines[i])return this._lines[i]},getDescription:function(includeHtml){if(includeHtml===false)return SUtil.removeHtml(this._description);else return this._description},getDuration:function(format){if(format===false)return this._duration;else return formatTime(this._duration,"bustime")}});var TransitRoutePlanp=TransitRoutePlan[Tprototype]; exportSymbol(TransitRoutePlanp,{"getNumLines":TransitRoutePlanp.getNumLines,"getLine":TransitRoutePlanp.getLine,"getNumRoutes":TransitRoutePlanp.getNumRoutes,"getRoute":TransitRoutePlanp.getRoute,"getDistance":TransitRoutePlanp.getDistance,"getDuration":TransitRoutePlanp.getDuration,"getDescription":TransitRoutePlanp.getDescription});function Route(opts){this._steps=opts.steps&&opts.steps.slice(0)||[];this._distance=opts.distance||0;this._index=opts.index||0;this._points=opts.points.slice(0);this._planIndex=opts.planIndex||0;this._rt=opts.rt;if(this._distance===0&&this._points[Tlength]>2)this._points[Tlength]=2} baidu[Textend](Route[Tprototype],{getNumSteps:function(){return this._steps[Tlength]},getStep:function(i){if(this._steps[i])return this._steps[i]},getDistance:function(format){if(format===false)return this._distance;else return formatDistance(this._distance)},getIndex:function(){return this._index},getPolyline:function(){return this._polyline},getPath:function(){return this._points},getRouteType:function(){return this._rt},getPlanIndex:function(){return this._planIndex}});var RouteP=Route[Tprototype]; exportSymbol(RouteP,{"getNumSteps":RouteP.getNumSteps,"getStep":RouteP.getStep,"getDistance":RouteP.getDistance,"getIndex":RouteP.getIndex,"getPolyline":RouteP.getPolyline,"getPath":RouteP.getPath,"getRouteType":RouteP.getRouteType});function Line(opts){this["title"]=opts.title;this.uid=opts.uid;this["type"]=opts.type;this._stops=opts.stops.slice(0);this._points=opts.points.slice(0);this._distance=opts.distance||0;this._numViaStops=opts.numViaStops||0} baidu[Textend](Line[Tprototype],{getNumViaStops:function(){return this._numViaStops},getGetOnStop:function(){return this._stops[0]},getGetOffStop:function(){return this._stops[1]},getPath:function(){return this._points},getPolyline:function(){return this._polyline},getDistance:function(format){if(format===false)return this._distance;else return formatDistance(this._distance)}});var LineP=Line[Tprototype]; exportSymbol(LineP,{"getNumViaStops":LineP.getNumViaStops,"getGetOnStop":LineP.getGetOnStop,"getGetOffStop":LineP.getGetOffStop,"getPath":LineP.getPath,"getPolyline":LineP.getPolyline,"getDistance":LineP.getDistance});function Step(opts){this._point=opts.point;this._index=opts.index;this._description=opts.description;this._distance=opts.distance||0;this._routeIndex=opts.routeIndex||0;this._planIndex=opts.planIndex||0} baidu[Textend](Step[Tprototype],{getPosition:function(){return this._point},getIndex:function(){return this._index},getDescription:function(includeHtml){if(includeHtml===false)return SUtil.removeHtml(this._description);else return this._description},getDistance:function(format){if(format===false)return this._distance;else return formatDistance(this._distance)},getRouteIndex:function(){return this._routeIndex},getPlanIndex:function(){return this._planIndex}});var StepP=Step[Tprototype]; exportSymbol(StepP,{"getPosition":StepP.getPosition,"getIndex":StepP.getIndex,"getDescription":StepP.getDescription,"getDistance":StepP.getDistance});BaseRoute._genTitle=function(title,clickBhv,seFlag){var borderStyle="border-bottom:1px solid #ccc";var imgOffsetY="-21px";if(seFlag===0){borderStyle+=";border-top:1px solid #ccc";imgOffsetY="5px"}var res=["<div style=\'"+borderStyle+"\'><div style=\'cursor:pointer;background:url("];res.push(API_URL+"img/trans_icons.png) no-repeat 5px "+imgOffsetY+";padding:8px 0 8px 33px;line-height:15px\' ");res.push("onclick=\'"+clickBhv+"\'"+"><span style=\'white-space:nowrap\'>");res.push(title);res.push("</span></div></div>"); return res.join("")};BaseRoute._genResultTitle=function(destName,description,addBottomBorder){return\'<h1 style="margin:0;border-top:1px solid #ccc;\'+(addBottomBorder?"border-bottom:1px solid #ccc;padding:10px 0 10px 7px;":"padding:10px 0 9px 7px;")+"font:bold 16px "+MapConfig.fontFamily+\'"> \'+description+"\\u524d\\u5f80 "+destName+" \\u7684\\u8def\\u7ebf</h1>"}; baidu[Textend](BaseRoute[Tprototype],{search:function(start,end){if(!start||!end){this.clearResults();this._setStatus(BMAP_STATUS_INVALID_REQUEST);this._triggerCbk(BaseSearch.CBK_SEARCH_COMPLETE);return false}return true},clearResults:function(){delete this._results;delete this._ud;delete this._json;delete this._boundsPoints;delete this._segPolylinePoints;var renderOptions=this._opts.renderOptions;this._setStatus();if(renderOptions.panel)renderOptions.panel.innerHTML="";if(renderOptions.map)renderOptions.map.closeInfoWindow(); this._clearOverlays();this._curIndex=-1},_formatDestQuery:function(dest,opt){var ret;opt=opt||{};if(typeof dest=="string")ret=[2,"","",dest,"",""];else if(dest instanceof Point){var pt=MercatorProjection.convertLL2MC(dest);ret=[1,"",pt["lng"]+","+pt["lat"],opt.wd||"","",""]}else{var pt=MercatorProjection.convertLL2MC(dest["point"]);ret=[1,dest.uid,pt["lng"]+","+pt["lat"],dest.title,"",""]}return ret.join("$$")}});var DEST_START=0;var DEST_END=1; function formatDistance(dis){if(typeof dis=="string")dis=TparseFloat(dis);var ret;if(!dis||dis<0)ret="0\\u7c73";else if(dis<=10)ret="10\\u7c73";else ret=dis<1E3?TMath.round(dis/10)*10+"\\u7c73":(dis/1E3).toFixed(1)+"\\u516c\\u91cc";if(ret=="1000\\u7c73")ret="1.0\\u516c\\u91cc";return ret} function formatTime(seconds,mode){if(!seconds||isNaN(seconds))return"";var stime="",m=60,d=m*24;var minutes=TMath.ceil(seconds/m);if(mode=="bustime"){var a=minutes%10,b=TparseInt(minutes/10);minutes=a!=0?a>5?++b*10:b?b*10:5:minutes}var days=TparseInt(minutes/d);minutes%=d;var hours=TparseInt(minutes/m);minutes%=m;if(days>=1)stime+=days+"\\u5929";if(hours>=1)stime+=hours+"\\u5c0f\\u65f6";if(minutes>=1)if(mode&&mode=="nav"&&days>=1)return stime;else stime+=minutes+"\\u5206\\u949f";return stime} function getPointsByBounds(bounds){var pt0=bounds.getSouthWest();var pt1=bounds.getNorthEast();return[pt0,pt1]}exportSymbol(BaseRouteP,{"clearResults":BaseRouteP.clearResults});baidu[Textend](TransitRoute[Tprototype],{_asyncSearch:function(){for(var i=0,l=this._queryList[Tlength];i<l;i++){var q=this._queryList[i];this[q.method].apply(this,q.arguments)}delete this._queryList},_internalSearch:function(sn,en){var me=this;function getPos(s){var a=s.split("$$"),type=a[0],pos=null;if(/[0-2]/.test(type)&&a[Tlength]===7)pos=a[+type+1];return pos}this._getIdByLoc(this._loc,function(id){var params={"qt":me.QUERY_TYPE,"c":id,"sn":sn,en:en,"sy":me._opts.policy||0,"ext":1};if(params["sy"]== BMAP_TRANSIT_POLICY_AVOID_SUBWAYS)params["f"]="[0,2,4,7,5,8,9,10,11]";var start=getPos(sn),end=getPos(en);SearchRequestMgr.request(function(json,userData){me._rawDataCbk(json,userData)},params,{start:start,end:end})})},search:function(start,end){if(BaseRoute[Tprototype].search.call(this,start,end)==true){var me=this;this._getIdByLoc(this._loc,function(id){if(!id){this._setStatus(BMAP_STATUS_INVALID_REQUEST);this._triggerCbk(BaseSearch.CBK_SEARCH_COMPLETE)}var params;if(typeof start=="object"&&typeof end== "string"||typeof start=="string"&&typeof end=="object")if(typeof start=="string")params={"qt":QUERY_TYPE_TRANSIT_SINGLE,"c":id,"isSingle":true,"wd":start,"en":me._formatDestQuery(end),"sy":me._opts.policy||0,"ex":1};else{if(typeof end=="string")params={"qt":QUERY_TYPE_TRANSIT_SINGLE,"c":id,"isSingle":true,"wd":end,"sn":me._formatDestQuery(start),"sy":me._opts.policy||0,"ex":1}}else params={"qt":me.QUERY_TYPE,"c":id,"sn":me._formatDestQuery(start),"en":me._formatDestQuery(end),"sy":me._opts.policy|| 0,"ex":1};if(params["sy"]==BMAP_TRANSIT_POLICY_AVOID_SUBWAYS)params["f"]="[0,2,4,7,5,8,9,10,11]";SearchRequestMgr.request(function(json,userData){me._rawDataCbk(json,userData)},params,{start:start,end:end})})}},_rawDataCbk:function(json,userData){this.clearResults();this._json=json;var r=json["result"];this._ud=userData;if(r["error"]!=0||r["type"]!=this.RETURN_TYPE||!json["content"]){if(r["type"]==RETURN_TYPE_ROUTE_ADDRESS){var total=r["total"],prio_flag=r["prio_flag"],startStatus,endStatus;startStatus= this._getRouteStatus(total[0],prio_flag[0]);endStatus=this._getRouteStatus(total[1],prio_flag[1])}this._results=new TransitRouteResult({city:json["current_city"]["name"],plans:[],policy:r["sy"],startStatus:startStatus,endStatus:endStatus});this._setStatus(BMAP_STATUS_UNKNOWN_ROUTE);this._triggerCbk(BaseSearch.CBK_SEARCH_COMPLETE,this._results);return}this._processRaw();this._renderList();this["_selectPlan"](0)},_getRouteStatus:function(total,prio_flag){var status=BMAP_ROUTE_STATUS_NORMAL;if(prio_flag== 0)if(total>0)status=BMAP_ROUTE_STATUS_ADDRESS;else status=BMAP_ROUTE_STATUS_EMPTY;return status},_processRaw:function(){var r=this._json["result"];var c=this._json["content"];var cc=this._json["current_city"];var start={};var end={};if(typeof this._ud.start=="object"&&!(this._ud.start instanceof Point))baidu[Textend](start,this._ud.start);else{start["title"]=r["start"]["wd"]||"\\u8d77\\u70b9";start["uid"]=r["start"]["uid"];start["url"]=BaseSearch._getPoiUrl(start["uid"],cc["code"]);start["point"]=SUtil.parseGeo(r["start"]["pt"], true).point;start["city"]=cc["name"]}if(typeof this._ud.end=="object"&&!(this._ud.end instanceof Point))baidu[Textend](end,this._ud.end);else{end["title"]=r["end"]["wd"]||"\\u7ec8\\u70b9";end["uid"]=r["end"]["uid"];end["url"]=BaseSearch._getPoiUrl(end["uid"],cc["code"]);end["point"]=SUtil.parseGeo(r["end"]["pt"],true).point;end["city"]=cc["name"]}var plans=[],bdIndex=0;this._boundsPoints=[];for(var i=0;i<c["length"];i++){if(bdIndex>this._opts.pageCapacity-1)break;for(var x=0,xLen=c[i]["stops"]["length"];x< xLen;x++){if(bdIndex>this._opts.pageCapacity-1)break;this._boundsPoints[bdIndex]=[];var stops=c[i]["stops"][x];var lines=c[i]["lines"][x];var len=0;for(var n=0,l=lines["length"];n<l;n++)if(typeof lines[n]=="object")len++;var duration=lines[len+1],resLines=[],wRoutes=[],dis=0,desc="";for(var j=0;j<stops["length"]-1;j++){var on=stops[j]["getOn"];var onStop={"title":on["name"],"uid":on["uid"],"url":BaseSearch._getPoiUrl(on["uid"],cc["code"]),"city":cc["name"],"point":SUtil.parseGeo(on["geo"],true).point}; var off=stops[j+1]["getOff"];var offStop={"title":off["name"],"uid":off["uid"],"url":BaseSearch._getPoiUrl(off["uid"],cc["code"]),"city":cc["name"],"point":SUtil.parseGeo(off["geo"],true).point};var walkPoints=[];if(j==0){if(stops[j]["walk"]["distance"]>0)walkPoints=SUtil.parseGeo(stops[j]["walk"]["geo"],true).points.concat(onStop["point"]);wRoutes.push(new Route({distance:stops[j]["walk"]["distance"],points:walkPoints.slice(0),rt:BMAP_ROUTE_TYPE_WALKING,index:j,planIndex:i}))}else{if(stops[j]["walk"]["distance"]> 0){var prevOffPoint=SUtil.parseGeo(stops[j]["getOff"]["geo"],true).point;var nextOnPoint=SUtil.parseGeo(stops[j]["getOn"]["geo"],true).point;walkPoints=[prevOffPoint].concat(SUtil.parseGeo(stops[j]["walk"]["geo"],true).points).concat(nextOnPoint)}wRoutes.push(new Route({distance:stops[j]["walk"]["distance"],points:walkPoints.slice(0),rt:BMAP_ROUTE_TYPE_WALKING,index:j,planIndex:i}))}dis+=stops[j]["walk"]["distance"];if(j==stops["length"]-2){if(stops[j+1]["walk"]["distance"]>0)walkPoints=[offStop["point"]].concat(SUtil.parseGeo(stops[j+ 1]["walk"]["geo"],true).points);wRoutes.push(new Route({distance:stops[j+1]["walk"]["distance"],points:walkPoints.slice(0),rt:BMAP_ROUTE_TYPE_WALKING,index:j+1,planIndex:i}));dis+=stops[j+1]["walk"]["distance"]}var lineGeo=SUtil.parseGeo(lines[j]["geo"],true);resLines.push(new Line({title:lines[j]["name"],uid:lines[j]["uid"],distance:lines[j]["distance"],points:lineGeo.points,stops:[onStop,offStop],type:this._getLineType(lines[j]["type"]),numViaStops:lines[j]["station_num"]}));var bpts=getPointsByBounds(lineGeo.bounds); this._boundsPoints[bdIndex].push(bpts[0],bpts[1]);dis+=lines[j]["distance"];if(stops[j]["walk"]["distance"])desc+="<b>\\u6b65\\u884c</b>\\u7ea6"+formatDistance(stops[j]["walk"]["distance"])+"\\uff0c\\u5230\\u8fbe<b>"+onStop["title"]+"</b>\\uff0c";desc+="\\u4e58\\u5750<b>"+this._shortTitle(lines[j]["name"])+"</b>\\uff0c\\u7ecf\\u8fc7"+lines[j]["station_num"]+"\\u7ad9\\uff0c\\u5230\\u8fbe<b>"+offStop["title"]+"</b>";if(j<stops["length"]-2)desc+="\\uff0c";else if(stops[j+1]["walk"]["distance"])desc+="\\uff0c<b>\\u6b65\\u884c</b>\\u7ea6"+ formatDistance(stops[j+1]["walk"]["distance"])+"\\uff0c\\u5230\\u8fbe<b>"+stops[j+1]["getOn"]["name"]+"</b>"}plans.push(new TransitRoutePlan({routes:wRoutes,distance:dis,duration:duration,lines:resLines,description:desc}));bdIndex++}}var url=MAP_URL+"?s="+encodeURIComponent(this.QUERY_TYPE+"&c="+cc["code"]+"&sy="+r["sy"]+"&sn="+this._formatDestQuery(this._ud.start)+"&en="+this._formatDestQuery(this._ud.end)+"&sq="+(this._ud.start["title"]?this._ud.start["title"]:this._ud.start)+"&eq="+(this._ud.end["title"]? this._ud.end["title"]:this._ud.end))+"&sr=1";if(this._ud.start instanceof Point&&this._ud.end instanceof Point)url="";if(typeof this._ud.start=="object"&&typeof this._ud.end=="string"||typeof this._ud.start=="string"&&typeof this._ud.end=="object")url="";this._results=new TransitRouteResult({city:cc["name"],plans:plans,start:start,end:end,url:url,policy:r["sy"]});this._setStatus(BMAP_STATUS_SUCCESS);this._triggerCbk(BaseSearch.CBK_SEARCH_COMPLETE,this._results)},_renderPlan:function(index){var map= this._opts.renderOptions.map;if(!map)return;var plan=this._results.getPlan(index);if(!plan)return;var startPoi=this._results.getStart();var endPoi=this._results.getEnd();var staMkr=APIPack.addDestPoi(map,startPoi["point"],startPoi["title"],DEST_START);startPoi["marker"]=staMkr;staMkr[TaddEventListener]("click",function(){me["_select"](0)});this._overlays.push(staMkr);var endMkr=APIPack.addDestPoi(map,endPoi["point"],endPoi["title"],DEST_END);endPoi["marker"]=endMkr;this._overlays.push(endMkr);endMkr[TaddEventListener]("click", function(){me["_selectLast"]()});var startPt=startPoi["point"];var endPt=endPoi["point"];this._boundsPoints[index].push(startPt,endPt);var transPois=[];var me=this;for(var i=0,l=plan.getNumLines();i<l;i++){var line=plan.getLine(i);var polyline=APIPack.addLine(map,line.getPath());line._polyline=polyline;this._overlays.push(polyline);var on=line.getGetOnStop();transPois.push(on);var onMkr=APIPack.addTransPoi(map,on["point"],line["type"],on["title"]);on["marker"]=onMkr;this._overlays.push(onMkr);var off= line.getGetOffStop();transPois.push(off);var offMkr=APIPack.addTransPoi(map,off["point"],line["type"],off["title"]);off["marker"]=offMkr;(function(){var curIndex=i;onMkr[TaddEventListener]("click",function(){me["_select"]((curIndex+1)*2-1)});offMkr[TaddEventListener]("click",function(){me["_select"]((curIndex+1)*2)})})();this._overlays.push(offMkr);var route=plan.getRoute(i);if(route.getDistance(false)>0){polyline=APIPack.addRoute(map,route.getPath(),route.getRouteType());route._polyline=polyline; this._overlays.push(polyline)}}var route=plan.getRoute(i);polyline=APIPack.addRoute(map,route.getPath(),route.getRouteType());route._polyline=polyline;this._overlays.push(polyline);var me=this;if(this._opts.renderOptions.autoViewport)map.setViewport(this._boundsPoints[index],{"margins":[30,30,30,30]});this._triggerCbk(BaseSearch.CBK_POLYLINES_SET,plan._lines,plan._routes);this._triggerCbk(BaseSearch.CBK_MARKERS_SET,[startPoi,endPoi],transPois)},_renderList:function(){if(this._opts.renderOptions.panel&& this._opts.renderOptions.panel[TappendChild]&&this._results&&this._results.getNumPlans()>0){var container=create("div",{style:"font:12px "+MapConfig.fontFamily+";background:#fff"});var title=BaseRoute._genResultTitle(this._results.getEnd()["title"],"\\u4e58\\u516c\\u5171\\u4ea4\\u901a\\u5de5\\u5177");var divSta=BaseRoute._genTitle(this._results.getStart()["title"],\'Instance("\'+this.guid+\'")["_select"](0)\',0);var tables=["<table style=\'font:12px "+MapConfig.fontFamily+";border-collapse:collapse\' cellpadding=\'0\' cellspacing=\'0\' border=\'0\'>"]; for(var i=0,l=this._results.getNumPlans();i<l;i++){var plan=this._results.getPlan(i),dis=plan.getDistance().replace(/(\\d+(?:.\\d+)?)/,"$1 "),dur=plan.getDuration().replace(/(\\d+)/,"$1 "),bg="";if(this._curIndex==i)bg=";background:#f0f0f0";var commonStyle="border-bottom:1px solid #ccc;vertical-align:top;";tables.push(\'<tr style="cursor:pointer\'+bg+\'" onclick=\\\'Instance("\'+this.guid+\'")._selectPlan(\'+i+")\'>");tables.push("<td style=\'"+commonStyle+"width:20px;text-align:right;padding:4px 3px\' >"+(i+1)+ ".</td>");tables.push("<td style=\'"+commonStyle+"padding:2px;line-height:18px\' ><div sytle=\'padding:0;margin:0;\'>"+dis+" / "+dur+"</div><div style=\'padding:0;margin:0px;\'>"+plan.getDescription()+"</div></td>");tables.push("</tr>")}tables.push("</table>");var divEnd=BaseRoute._genTitle(this._results.getEnd().title,\'Instance("\'+this.guid+\'")["_selectLast"]()\',1);var control="<div style=\'border-bottom:1px solid #ccc;margin-bottom:10px;color:#7777cc;background:#e5ecf9;"+"overflow:hidden;padding:2px;text-align:right\'>"; if(this._results["moreResultsUrl"])control+="<a style=\'color:#7777cc\' href=\'"+this._results["moreResultsUrl"]+"\' target=\'_blank\'>\\u5230\\u767e\\u5ea6\\u5730\\u56fe\\u67e5\\u770b&#187;</a>";control+="&nbsp;</div>";container.innerHTML=title+divSta+tables.join("")+divEnd+control;this._opts.renderOptions.panel[TappendChild](container);this._triggerCbk(BaseSearch.CBK_RESULTS_HTML_SET,container)}},"_select":function(index){var map=this._opts.renderOptions.map;if(map){var plan=this._results.getPlan(this._curIndex); if(!plan)return;var me=this;var total=plan.getNumLines()*2;if(index==0||index==total+1){var d=index===0?this._results.getStart():this._results.getEnd();var iw=APIPack.createTransInfoWnd({content:"<b>"+d["title"]+"</b>",total:total,curIndex:index,nextTransCbk:function(i){me["_select"](i)}});iw[TaddEventListener]("open",function(){me._triggerCbk(BaseSearch.CBK_INFO_HTML_SET,d,APIPack.getInfoWindowDom(map))});var oindex=index===0?0:1;this._overlays[oindex].openInfoWindow(iw)}else{var curLine=plan.getLine(TMath.floor((index+ 1)/2)-1);var curStop;var desc;if(index%2===1){curStop=curLine.getGetOnStop();desc="<b>"+curStop["title"]+"\\u7ad9\\u4e0a\\u8f66</b>"}else{curStop=curLine.getGetOffStop();desc="<b>"+curStop["title"]+"\\u7ad9\\u4e0b\\u8f66</b>"}var iw=APIPack.createTransInfoWnd({content:desc,total:total,curIndex:index,nextTransCbk:function(i){me["_select"](i)}});iw[TaddEventListener]("open",function(){me._triggerCbk(BaseSearch.CBK_INFO_HTML_SET,curStop,APIPack.getInfoWindowDom(map))});curStop["marker"].openInfoWindow(iw)}}}, "_selectLast":function(){if(this._results&&this._curIndex>-1){var plan=this._results.getPlan(this._curIndex);if(!plan)return;var total=plan.getNumLines()*2;this["_select"](total+1)}},"_selectPlan":function(index){if(!this._results&&!this._result.getPlan(index))return;var plan=this._results.getPlan(index);var map=this._opts.renderOptions.map;if(map){map.closeInfoWindow();this._clearOverlays();this._renderPlan(index)}if(this._opts.renderOptions.panel){var table=this._opts.renderOptions.panel.getElementsByTagName("table")[0]; if(!table)return;var trs=table.getElementsByTagName("tr");if(this._curIndex>=0&&trs[this._curIndex])trs[this._curIndex].style.background="";if(index>=0&&trs[index])trs[index].style.background="#f0f0f0"}this._curIndex=index},_clearOverlays:function(){for(var i=0;i<this._overlays[Tlength];i++){if(this._overlays[i]._p){this._overlays[i]._p.remove();this._overlays[i]._p=null}this._overlays[i].remove();this._overlays[i]=null}this._overlays[Tlength]=0},_getLineType:function(type){return TransitRoute.LINE_TYPE_MAPPING[type]}});DWRoute.MAX_THRESHOLD=20;DWRoute.DRAG_REQ_FREQUENCE=50;DWRoute.DRAG_MAXPOINTS=10; baidu[Textend](DWRoute[Tprototype],{init_d:function(){this._d={plys:[],viaPts:[],viaPtsInfo:[],dragOverlays:[],tipLbl:null,sliderMkr:null,dragReqFlag:false,cbkDragPt:null,cbkPly:null,isSearchByDrag:false,curDragPly:null,dragSrcCityCode:1,dragEndCityCode:1,cbkStartPoiName:"\\u8d77\\u70b9",cbkEndPoiName:"\\u7ec8\\u70b9",mouseOnViaMkr:false,cxtMenu:[]}},_asyncSearch:function(){this.init_d();for(var i=0,l=this._queryList[Tlength];i<l;i++){var q=this._queryList[i];this[q.method].apply(this,q.arguments)}delete this._queryList}, search:function(start,end,opts){this._d.isSearchByDrag=false;var opts=opts||{};if(BaseRoute[Tprototype].search.call(this,start,end)==true){var me=this;this._getIdByLoc(this._loc,function(id){id=id||1;var params;if(typeof start=="object"&&typeof end=="string"||typeof start=="string"&&typeof end=="object"){if(typeof start=="string")params={"qt":QUERY_TYPE_DRIVING_SINGLE,"c":id,"isSingle":true,"wd":start,"en":me._formatDestQuery(end),"sy":me._opts.policy||0};else if(typeof end=="string")params={"qt":QUERY_TYPE_DRIVING_SINGLE, "c":id,"isSingle":true,"wd":end,"sn":me._formatDestQuery(start),"sy":me._opts.policy||0};this.QUERY_TYPE=QUERY_TYPE_DRIVING_SINGLE}else params={"qt":me.QUERY_TYPE,"c":id,"sn":me._formatDestQuery(start),"en":me._formatDestQuery(end),"sy":me._opts.policy||0};var ud={start:start,end:end};if(opts["startCity"])params["sc"]=opts["startCity"];if(opts["endCity"])params["ec"]=opts["endCity"];SearchRequestMgr.request(function(json,userData){me._rawDataCbk(json,userData)},params,ud)})}},_dragSearch:function(start, end){var me=this;me._d.isSearchByDrag=true;me._getIdByLoc(me._loc,function(id){id=id||1;var stPt=MercatorProjection.convertLL2MC(me._d.viaPts[0]);var snStr="1$$$$"+stPt["lng"]+","+stPt["lat"]+"$$$$";var scStr=me._d.dragSrcCityCode||id;var edStr="",ecStr="";for(var i=1,l=me._d.viaPts[Tlength];i<l;i++){var viaPt=MercatorProjection.convertLL2MC(me._d.viaPts[i]);if(i==l-1){edStr+="1$$$$"+viaPt["lng"]+","+viaPt["lat"]+"$$$$";ecStr+=me._d.dragEndCityCode||id}else{edStr+="1$$$$"+viaPt["lng"]+","+viaPt["lat"]+ "$$$$"+"+to:";ecStr+="0 +to:"}}var params={"qt":me.QUERY_TYPE,"c":id,"drag":1,"sc":scStr,"ec":ecStr,"sn":snStr,"en":edStr,"sy":me._opts.policy||0};var ud={start:start,end:end};baidu[Textend](ud,{"useEncodeURI":true});SearchRequestMgr.request(function(json,userData){me._rawDataCbk(json,userData)},params,ud)})},_rawDataCbk:function(json,userData){this.clearResults();this._json=json;var r=json["result"];this._ud=userData;if(r["error"]!=0||r["type"]!=this.RETURN_TYPE){if(r["type"]==RETURN_TYPE_ROUTE_ADDRESS){var total= r["total"],prio_flag=r["prio_flag"],startStatus,endStatus;startStatus=this._getRouteStatus(total[0],prio_flag[0]);endStatus=this._getRouteStatus(total[1],prio_flag[1])}this._results=this._createResults({city:json["current_city"]["name"],plans:[],policy:r["sy"],startStatus:startStatus,endStatus:endStatus});this._setStatus(BMAP_STATUS_UNKNOWN_ROUTE);this._triggerCbk(BaseSearch.CBK_SEARCH_COMPLETE,this._results);return}this._processRaw();this._renderMap();this._renderList()},_getRouteStatus:function(total, prio_flag){var status=BMAP_ROUTE_STATUS_NORMAL;if(prio_flag==0)if(total>0)status=BMAP_ROUTE_STATUS_ADDRESS;else status=BMAP_ROUTE_STATUS_EMPTY;return status},_stopDragging:function(){var me=this;if(me._d.sliderMkr)me._d.sliderMkr.disableDragging();for(var i=0,l=this._d.dragOverlays[Tlength];i<l;i++){var overlay=this._d.dragOverlays[i];if(overlay instanceof Marker)overlay.disableDragging()}},_processRaw:function(){var r=this._json["result"];var c=this._json["content"];var cc=this._json["current_city"]; var kps=c["kps"];var rss=c["rss"];var start={};var end={};if(typeof this._ud.start=="object"&&!(this._ud.start instanceof Point))baidu[Textend](start,this._ud.start);else{start["title"]=r["start"]["wd"]||"\\u8d77\\u70b9";start["uid"]=r["start"]["uid"];start["url"]=BaseSearch._getPoiUrl(start.uid,r["start_city"]["code"]);start["point"]=SUtil.parseGeo(r["start"]["pt"],true).point;start["city"]=r["start_city"]["cname"]}this._d.dragSrcCityCode=r["start_city"]["code"];if(typeof this._ud.end=="object"&&!(this._ud.end instanceof Point))baidu[Textend](end,this._ud.end);else{var endNode,endCityNode;if(this._d.isSearchByDrag){endNode=r["end"][r["end"]["length"]-1];endCityNode=r["end_city"][r["end_city"]["length"]-1]}else{endNode=r["end"][0];endCityNode=r["end_city"][0]}this._d.dragEndCityCode=endCityNode["code"];end["title"]=endNode["wd"]||"\\u7ec8\\u70b9";end["uid"]=endNode["uid"];if(end["uid"]=="null")end["uid"]="";end["url"]=BaseSearch._getPoiUrl(endNode["uid"],endCityNode["code"]);end["point"]=SUtil.parseGeo(endNode["pt"], true).point;end["city"]=endCityNode["cname"]}var allRouteSteps=[];var curRouteSteps=[];var arrRouteDis=[];var curRouteDis=0;var polylinePoints=[];this._segPolylinePoints=[];var dragVias=[],dragPlys=[],dragSegPly=[];var count=0;this._d.viaPtsInfo[Tlength]=0;var viaPtNo=1;for(var i=0,l=kps["length"]-1;i<l;i++){var curKps=kps[i];var nxtKps=kps[i+1];var curRss=rss[i];var preRss=rss[i-1]||{};var nxtRss=rss[i+1];var pt=SUtil.parseGeo(curKps["pt"],true).point;var dis=TparseInt(curRss["d"]);var cur=SUtil.parseGeo(curRss["g"], true);if(cur)dragSegPly=dragSegPly.concat(cur.points);curRouteDis+=nxtRss["d"];if(curKps["rt"]==3){dragVias.push(pt);dragPlys.push(dragSegPly.slice(0));dragSegPly=[];allRouteSteps.push(curRouteSteps.slice(0));curRouteSteps=[];arrRouteDis.push(curRouteDis);curRouteDis=0;var viaPtName=preRss["n"]||nxtRss["n"]||"\\u672a\\u77e5\\u8def\\u6bb5";var viaNo=viaPtNo;this._d.viaPtsInfo.push({"title":viaPtName,"curNo":viaPtNo,"point":pt});viaPtNo++}else{var des=this._getDescription(curKps,curRss,nxtRss,i,l,preRss, nxtKps);var idx=curRouteSteps[Tlength];var step=new Step({point:pt,index:idx,description:des,distance:nxtRss["d"]});curRouteSteps.push(step);if(cur){if(i>1)this._segPolylinePoints[count]=[polylinePoints[polylinePoints[Tlength]-1]].concat(cur.points);else this._segPolylinePoints[count]=cur.points;polylinePoints=polylinePoints.concat(cur.points)}count++}}if(dragSegPly[Tlength]>0)dragPlys.push(dragSegPly);if(curRouteSteps[Tlength]>0)allRouteSteps.push(curRouteSteps);if(curRouteDis>0)arrRouteDis.push(curRouteDis); var arrRoutes=[];for(var i=0,l=dragPlys[Tlength];i<l;i++){var route=new Route({steps:allRouteSteps[i],distance:arrRouteDis[i],index:i,points:dragPlys[i],rt:this.ROUTE_TYPE});arrRoutes.push(route)}var time=c["time"];if(this.QUERY_TYPE==QUERY_TYPE_WALKING)time=TMath.round(c["dis"]/1.35);var rp=new RoutePlan({routes:arrRoutes,distance:c["dis"],duration:time,dragPois:this._d.viaPtsInfo});var url="",param={},qt=null,bounds=null,startType="string",endType="string",map=this._opts.renderOptions.map;if(this._ud.start instanceof Point)startType="point";if(this._ud.end instanceof Point)endType="point";if(startType==="point"&&endType==="string"||startType==="string"&&endType==="point"){qt=QUERY_TYPE_DRIVING_SINGLE;bounds=map.getBounds();baidu[Textend](param,{"c":cc["code"],"isSingle":true,"sy":r["sy"],"newmap":1,"nstep":1,"ie":"utf-8","l":map.getZoom()});if(startType==="string"){param["wd"]=this._ud.start;param["en"]=this._formatDestQuery(this._ud.end,{wd:"\\u7ec8\\u70b9"})}else{param["wd"]=this._ud.end;param["sn"]=this._formatDestQuery(this._ud.start, {wd:"\\u8d77\\u70b9"})}param["tn"]=map.getMapType()===BMAP_NORMAL_MAP?"B_NORMAL_MAP":"B_DIMENSIONAL_MAP"}else{qt=QUERY_TYPE_DRIVING;param["c"]=cc["code"];param["sc"]=r["start_city"]["code"];param["ec"]=r["end_city"][0]["code"];param["sy"]=r["sy"];param["sn"]=this._formatDestQuery(this._ud.start);param["en"]=this._formatDestQuery(this._ud.end);param["sq"]=this._ud.start["title"]?this._ud.start["title"]:this._ud.start;param["eq"]=this._ud.end["title"]?this._ud.end["title"]:this._ud.end}if(qt!==null)url= MAP_URL+"?s="+encodeURIComponent(qt+"&"+jsonToQuery(param))+"&sr=1";this._results=this._createResults({city:cc["name"],plans:[rp],start:start,end:end,url:url,policy:r["sy"],taxiFare:this._getTaxiFare()});this._d.viaPts[Tlength]=0;this._d.plys[Tlength]=0;var stPt=start["point"];this._d.viaPts.push(stPt);for(var i=0,l=dragVias[Tlength];i<l;i++){var viaPt=dragVias[i];this._d.viaPts.push(viaPt)}var edPt=end["point"];this._d.viaPts.push(edPt);for(var i=0,l=dragPlys[Tlength];i<l;i++){var segPly=dragPlys[i]; segPly.stNo=i;segPly.edNo=i+1;this._d.plys.push(segPly)}this._setStatus(BMAP_STATUS_SUCCESS);this._triggerCbk(BaseSearch.CBK_SEARCH_COMPLETE,this._results)},_getAllStepCount:function(){var count=0;var plan=this._results.getPlan(0);for(var i=0,l=plan.getNumRoutes();i<l;i++){var route=plan.getRoute(i);count+=route.getNumSteps()}return count},_getCurStep:function(index){var count=0;var plan=this._results.getPlan(0);for(var i=0,l=plan.getNumRoutes();i<l;i++){var route=plan.getRoute(i);for(var j=0,ll= route.getNumSteps();j<ll;j++){var step=route.getStep(j);if(count==index)return step;count++}}},_getDescription:function(curKps,curRss,nxtRss,i,l,preRss,nxtKps){var des="";var dis=TparseInt(curRss["d"]);var poi=curRss["poi"];if(poi)dis=dis-poi["pd"];var disstr=formatDistance(dis);var pnm=this._getRoadName(preRss["t"],preRss["n"]);var rnm=this._getRoadName(curRss["t"],curRss["n"]);var nnm=this._getRoadName(curRss["t"],nxtRss["n"]);var dw=this._getDwType(curKps["dw"])||"";var dr=curKps["dr"]?dw+"<b>"+ curKps["dr"]+"</b>\\uff0c":"";if(nxtKps["rt"]==3)dr+="\\u5230\\u8fbe"+"<b>"+this._getRetType(nxtKps["rt"])+"</b>\\uff0c";var act=(rnm!=""&&pnm==rnm?"\\u7ee7\\u7eed":"")+this._getRoadAct(curRss["t"],curRss["n"]);var tips=this._getPoiInfo(curRss);var tic=this._getTicInfo(curKps);var ret=rnm==nnm?"":this._getRetAct(nxtRss["t"],nxtRss["n"])+"<b>"+nnm+"</b>";des=act+"<b>"+rnm+"</b>"+this._getRetType(curKps["rt"])+disstr+"\\uff0c"+tips+tic+dr;if(i==0)des="\\u4ece<b>\\u8d77\\u70b9</b>\\u5411"+this._getTurnType(curKps["ett"]|| curKps["tt"])+"\\u51fa\\u53d1";else if(i>0&&i<l-1)des=des+"<b>"+this._getTurnType(curKps["ett"]||curKps["tt"])+"</b>"+ret;else des=des+"\\u5230\\u8fbe<b>\\u7ec8\\u70b9</b>";return des},_isInThreshold:function(map,sliderPix,viaPts){if(sliderPix&&viaPts&&viaPts[Tlength]>0)for(var i=0,l=viaPts[Tlength];i<l;i++){var viaPt=viaPts[i];var viaPix=map.pointToPixel(viaPt);if(APIPack.getDistanceByPixel(sliderPix,viaPix)<=DWRoute.MAX_THRESHOLD)return true}return false},_renderMap:function(){var map=this._opts.renderOptions.map; if(map&&this._results){this._renderViaMkr();this._renderPly()}},_renderPly:function(){var map=this._opts.renderOptions.map;var plan=this._results.getPlan(0);var route=plan.getRoute(0);var startPoi=this._results.getStart();var endPoi=this._results.getEnd();var me=this;var viaPtsCount=this._d.viaPts[Tlength];var viewPortPts=[];for(var i=0,l=this._d.plys[Tlength];i<l;i++){var path=this._d.plys[i];var ply=APIPack.addRoute(map,path,route.getRouteType());plan._routes[i]._polyline=ply;ply.stNo=path.stNo; ply.edNo=path.edNo;var plyBounds=ply.getBounds();viewPortPts.push(plyBounds.getSouthWest());viewPortPts.push(plyBounds.getNorthEast());if(this._enableDragging)if(viaPtsCount<DWRoute.DRAG_MAXPOINTS+2){ply[TaddEventListener]("mousemove",function(evt){if(me._d.mouseOnViaMkr){if(me._d.sliderMkr)me._d.sliderMkr.hide();return}me._d.curDragPly=this;if(me._d.sliderMkr)if(me._isInThreshold(map,evt["pixel"],me._d.viaPts))me._d.sliderMkr.hide();else{me._d.sliderMkr.show();me._d.sliderMkr.setPosition(evt["point"]); me._d.tipLbl.setContent("\\u62d6\\u52a8\\u4ee5\\u66f4\\u6539\\u8def\\u7ebf");me._d.tipLbl.show();me._d.sliderMkr.setLabel(me._d.tipLbl)}else{me._d.sliderMkr=APIPack.addDragMkr(map,evt["point"]);me._d.sliderMkr.enableDragging();me._d.sliderMkr[TaddEventListener]("dragging",function(evt){var stNo=me._d.curDragPly.stNo;var edNo=me._d.curDragPly.edNo;me._requestDragging(this,map,stNo,edNo)});me._d.sliderMkr[TaddEventListener]("dragend",function(evt){var cbkDragPt=me._d.cbkDragPt;var edNo=me._d.curDragPly.edNo; me._d.viaPts.splice(edNo,0,cbkDragPt);this.setPosition(cbkDragPt);me._stopDragging();me._dragSearch(startPoi,endPoi)});if(!me._d.tipLbl)me._d.tipLbl=APIPack.createTipLbl("\\u62d6\\u52a8\\u4ee5\\u66f4\\u6539\\u8def\\u7ebf");map.addOverlay(me._d.sliderMkr)}});ply[TaddEventListener]("mouseout",function(evt){if(me._d.sliderMkr)me._d.sliderMkr.hide()})}me._d.dragOverlays.push(ply)}if(this._opts.renderOptions.autoViewport)map.setViewport(viewPortPts,{"margins":[30,30,30,30]});this._triggerCbk(BaseSearch.CBK_POLYLINES_SET, plan._routes)},_renderViaMkr:function(){var map=this._opts.renderOptions.map;var plan=this._results.getPlan(0);var startPoi=this._results.getStart();var endPoi=this._results.getEnd();var me=this;for(var i=0,l=this._d.viaPts[Tlength];i<l;i++){var viaPt=this._d.viaPts[i];var dragMkr;if(i==0){dragMkr=APIPack.addDestPoi(map,viaPt,startPoi["title"],DEST_START);startPoi["marker"]=dragMkr;dragMkr[TaddEventListener]("click",function(){me["_select"](0)});this._overlays.push(dragMkr)}else if(i==this._d.viaPts[Tlength]- 1){dragMkr=APIPack.addDestPoi(map,viaPt,endPoi["title"],DEST_END);endPoi["marker"]=dragMkr;dragMkr[TaddEventListener]("click",function(){me["_select"](me._getAllStepCount()+1)});this._overlays.push(dragMkr)}else{dragMkr=APIPack.addDragMkr(map,viaPt);this._d.viaPtsInfo[i-1].marker=dragMkr;var viaCtxMenu=new ContextMenu;viaCtxMenu.addItem(new MenuItem("\\u5220\\u9664\\u8be5\\u70b9",function(pt,px,overlay){me._delVia(overlay.curNo)},{width:60}));dragMkr.addContextMenu(viaCtxMenu);me._d.cxtMenu.push(viaCtxMenu)}dragMkr.curNo= i;if(this._enableDragging){dragMkr.enableDragging();dragMkr[TaddEventListener]("mouseover",function(evt){me._d.mouseOnViaMkr=true;if(me._d.tipLbl){me._d.tipLbl.setContent("\\u62d6\\u52a8\\u4ee5\\u66f4\\u6539\\u8def\\u7ebf");me._d.tipLbl.show();this.setLabel(me._d.tipLbl)}else{me._d.tipLbl=APIPack.createTipLbl("\\u62d6\\u52a8\\u4ee5\\u66f4\\u6539\\u8def\\u7ebf");this.setLabel(me._d.tipLbl)}});dragMkr[TaddEventListener]("mouseout",function(evt){this.getLabel().hide();me._d.mouseOnViaMkr=false});dragMkr[TaddEventListener]("dragging", function(evt){me._requestDragging(this,map)});dragMkr[TaddEventListener]("dragend",function(evt){var cbkDragPt=me._d.cbkDragPt;var index=this.curNo;me._d.viaPts[index]=cbkDragPt;this.setPosition(cbkDragPt);var startPt=me._d.viaPts[0];var endPt=me._d.viaPts[me._d.viaPts[Tlength]-1];if(index==0){startPoi["point"]=startPt;startPoi["title"]=me._d.cbkStartPoiName}if(index==me._d.viaPts[Tlength]-1){endPoi["point"]=endPt;endPoi["title"]=me._d.cbkEndPoiName}me._stopDragging();me._dragSearch(startPoi,endPoi)})}me._d.dragOverlays.push(dragMkr)}var arrPois= [startPoi];arrPois=arrPois.concat(this._d.viaPtsInfo);arrPois=arrPois.concat([endPoi]);this._triggerCbk(BaseSearch.CBK_MARKERS_SET,arrPois)},_requestDragging:function(dragMkr,map,stNo,edNo){var me=this;if(me._d.dragReqFlag==true)return;me._d.dragReqFlag=true;setTimeout(function(){me._d.dragReqFlag=false},DWRoute.DRAG_REQ_FREQUENCE);var params;var dragPt=MercatorProjection.convertLL2MC(dragMkr.getPosition());var level=map.getZoom();var curNo=dragMkr.curNo;if(typeof stNo!="undefiend"&&typeof edNo!= "undefined"){var stPt=me._d.viaPts[stNo];stPt=MercatorProjection.convertLL2MC(stPt);var endPt=me._d.viaPts[edNo];endPt=MercatorProjection.convertLL2MC(endPt);params={"qt":QUERY_TYPE_DARG,"pt":dragPt["lng"]+","+dragPt["lat"],"sn":stPt["lng"]+","+stPt["lat"],"en":endPt["lng"]+","+endPt["lat"],"r":5E3,"st":1,"et":1,"sy":0,"l":level}}else if(curNo==0){var endPt=me._d.viaPts[curNo+1];endPt=MercatorProjection.convertLL2MC(endPt);params={"qt":QUERY_TYPE_DARG,"pt":dragPt["lng"]+","+dragPt["lat"],"sn":"", "en":endPt["lng"]+","+endPt["lat"],"r":5E3,"st":1,"et":1,"sy":0,"l":level}}else if(curNo==this._d.viaPts[Tlength]-1){var stPt=me._d.viaPts[curNo-1];stPt=MercatorProjection.convertLL2MC(stPt);params={"qt":QUERY_TYPE_DARG,"pt":dragPt["lng"]+","+dragPt["lat"],"sn":stPt["lng"]+","+stPt["lat"],"en":"","r":5E3,"st":1,"et":1,"sy":0,"l":level}}else{var stPt=me._d.viaPts[curNo-1];stPt=MercatorProjection.convertLL2MC(stPt);var endPt=me._d.viaPts[curNo+1];endPt=MercatorProjection.convertLL2MC(endPt);params= {"qt":QUERY_TYPE_DARG,"pt":dragPt["lng"]+","+dragPt["lat"],"sn":stPt["lng"]+","+stPt["lat"],"en":endPt["lng"]+","+endPt["lat"],"r":5E3,"st":1,"et":1,"sy":0,"l":level}}var userData={curDragMkr:dragMkr,map:map,stNo:stNo,edNo:edNo};SearchRequestMgr.request(function(json,userData){me._requestDraggingCbk(json,userData)},params,userData)},_requestDraggingCbk:function(json,userData){var me=this;if(json&&json["content"]){me._d.cbkDragPt=SUtil.parseGeo(json["content"]["dragpt"],true).point;var cbkPlyPts;var map= userData.map;var stNo=userData.stNo;var edNo=userData.edNo;var dragMkr=userData.curDragMkr;var curNo=dragMkr.curNo;if(typeof stNo!="undefiend"&&typeof edNo!="undefined")cbkPlyPts=SUtil.parseGeoExt(json["content"]["geo"]).points;else if(curNo==0){cbkPlyPts=SUtil.parseGeo(json["content"]["geo"],true).points;me._d.cbkStartPoiName=json["content"]["name"]?json["content"]["name"]:"\\u8d77\\u70b9"}else if(curNo==me._d.viaPts[Tlength]-1){cbkPlyPts=SUtil.parseGeo(json["content"]["geo"],true).points;me._d.cbkEndPoiName= json["content"]["name"]?json["content"]["name"]:"\\u7ec8\\u70b9"}else cbkPlyPts=SUtil.parseGeoExt(json["content"]["geo"]).points;if(cbkPlyPts){me._clearOldLine(curNo,map,stNo,edNo);if(me._d.cbkPly)me._d.cbkPly.setPath(cbkPlyPts);else{var plan=me._results.getPlan(0);var route=plan.getRoute(0);me._d.cbkPly=APIPack.addRoute(map,cbkPlyPts,route.getRouteType())}}var name=json["content"]["name"]?json["content"]["name"]:"\\u672a\\u77e5\\u8def\\u6bb5";var dis="("+formatDistance(json["content"]["dis"])+")";me._d.tipLbl.show(); me._d.tipLbl.setContent(name+dis)}},_clearOldLine:function(curNo,map,stNo,edNo){for(var i=0,l=this._d.dragOverlays[Tlength];i<l;i++){var dragOverlay=this._d.dragOverlays[i];if(dragOverlay instanceof Polyline)if(typeof stNo!="undefiend"&&typeof edNo!="undefined"){if(dragOverlay.stNo==stNo&&dragOverlay.edNo==edNo){map.removeOverlay(dragOverlay);break}}else if(dragOverlay.stNo==curNo||dragOverlay.edNo==curNo)map.removeOverlay(dragOverlay)}if(this._hlRoute)this._hlRoute.hide()},"_select":function(index){var preIndex= this._curIndex;var renderOptions=this._opts.renderOptions;if(renderOptions.panel){var tables=renderOptions.panel.getElementsByTagName("table");var table=tables[tables[Tlength]-1];var trs=table.getElementsByTagName("tr");if(preIndex-1>=0&&trs[preIndex-1])trs[preIndex-1].style.background="";if(index-1>=0&&trs[index-1])trs[index-1].style.background="#f0f0f0"}var map=renderOptions.map;if(map){var plan=this._results.getPlan(0);var route=plan.getRoute(0);var total=this._getAllStepCount();var me=this;map.closeInfoWindow(); if(index==0||index==total+1){var d=index===0?this._results.getStart():this._results.getEnd();var iw=APIPack.createTransInfoWnd({content:"<b>"+d.title+"</b>",total:total,curIndex:index,nextTransCbk:function(i){me["_select"](i)},hideStep:renderOptions.highlightMode==BMAP_HIGHLIGHT_STEP?false:true});iw[TaddEventListener]("open",function(){me._triggerCbk(BaseSearch.CBK_INFO_HTML_SET,d,APIPack.getInfoWindowDom(map))});iw[TaddEventListener]("close",function(){if(me._opts.renderOptions.panel){var tables= renderOptions.panel.getElementsByTagName("table");var table=tables[tables[Tlength]-1];if(table){var trs=table.getElementsByTagName("tr");if(me._curIndex-1>=0&&trs[me._curIndex-1])trs[me._curIndex-1].style.background=""}}me._curIndex=-1});var oindex=index===0?0:1;this._overlays[oindex].openInfoWindow(iw);if(this._hlRoute)this._hlRoute.hide()}else{var highlightMode=renderOptions.highlightMode;if(highlightMode==BMAP_HIGHLIGHT_STEP){var curStep=this._getCurStep(index-1);var iw=APIPack.createTransInfoWnd({content:curStep.getDescription(), total:total,curIndex:index,nextTransCbk:function(i){me["_select"](i)}});iw[TaddEventListener]("open",function(){me._triggerCbk(BaseSearch.CBK_INFO_HTML_SET,curStep,APIPack.getInfoWindowDom(map))});iw[TaddEventListener]("close",function(){if(me._opts.renderOptions.panel){var tables=renderOptions.panel.getElementsByTagName("table");var table=tables[tables[Tlength]-1];if(table){var trs=table.getElementsByTagName("tr");if(me._curIndex-1>=0&&trs[me._curIndex-1])trs[me._curIndex-1].style.background=""}}me._curIndex= -1});var pt=curStep.getPosition();map.openInfoWindow(iw,pt)}else if(highlightMode==BMAP_HIGHLIGHT_ROUTE)if(index==1){var curStep=this._getCurStep(0);map.setCenter(curStep.getPosition());if(renderOptions.autoViewport)map.setZoom(17);if(this._hlRoute)this._hlRoute.hide()}else if(this._segPolylinePoints[index-1]){if(!this._hlRoute)this._hlRoute=APIPack.addRoute(map,this._segPolylinePoints[index-1],route.getRouteType()+2);else{this._hlRoute.setPath(this._segPolylinePoints[index-1]);this._hlRoute.show()}if(renderOptions.autoViewport){var view= map.getViewport(this._hlRoute.getBounds());if(view["zoom"]>17)view["zoom"]=17;map.setViewport(view)}}}}this._curIndex=index},_clearOverlays:function(){var map=this._opts.renderOptions.map;if(!map)return;for(var i=0,l=this._overlays[Tlength];i<l;i++){map.removeOverlay(this._overlays[i]);this._overlays[i]=null}this._overlays[Tlength]=0;map.removeOverlay(this._hlRoute);this._hlRoute=null;if(this._d.sliderMkr){map.removeOverlay(this._d.sliderMkr);this._d.sliderMkr=null}if(this._d.tipLbl){map.removeOverlay(this._d.tipLbl); this._d.tipLbl=null}for(var i=0,l=this._d.dragOverlays[Tlength];i<l;i++){map.removeOverlay(this._d.dragOverlays[i]);this._d.dragOverlays[i]=null}this._d.dragOverlays[Tlength]=0;if(this._d.cbkPly){map.removeOverlay(this._d.cbkPly);this._d.cbkPly=null}for(var i=0,l=this._d.cxtMenu[Tlength];i<l;i++){map.removeContextMenu(this._d.cxtMenu[i]);this._d.cxtMenu[i]=null}this._d.cxtMenu[Tlength]=0;this._d.mouseOnViaMkr=false},_delVia:function(curNo){if(this._results){var startPoi=this._results.getStart();var endPoi= this._results.getEnd();this._d.viaPts.splice(curNo,1);this._stopDragging();this._dragSearch(startPoi,endPoi)}},_renderList:function(){if(this._opts.renderOptions.panel&&this._opts.renderOptions.panel[TappendChild]&&this._results&&this._results.getNumPlans()>0){var plan=this._results.getPlan(0);var container=create("div",{style:"font:12px "+MapConfig.fontFamily+";background:#fff"});var ptsInfo=this._d.viaPtsInfo;var viaCount=ptsInfo[Tlength];var viaHtml=[];var isDriving=this.QUERY_TYPE===QUERY_TYPE_DRIVING; var title=BaseRoute._genResultTitle(this._results.getEnd().title,isDriving?"\\u9a7e\\u8f66":"\\u6b65\\u884c",viaCount>0);if(viaCount>0){viaHtml.push("<table style=\'margin-left:4px;font:12px "+MapConfig.fontFamily+";border-collapse:collapse\' cellpadding=\'0\' cellspacing=\'0\' border=\'0\'>");for(var i=0;i<viaCount;i++){viaHtml.push("<tr>");if(i==0)if(viaCount==1)viaHtml.push(\'<td style="padding:2px 5px;line-height:18px">\\u9014\\u7ecf\\u70b9</td>\');else viaHtml.push(\'<td valign="top" rowspan="\'+viaCount+\'" style="padding:2px 5px;line-height:18px">\\u9014\\u7ecf\\u70b9</td>\'); viaHtml.push(\'<td style="padding:2px 5px;line-height:18px">\'+ptsInfo[i].title+"</td>");viaHtml.push(\'<td style="padding:2px 10px;line-height:18px;cursor:pointer;color:#0000ff" onclick=\\\'Instance("\'+this.guid+\'")._delVia(\'+ptsInfo[i].curNo+")\'>\\u5220\\u9664</td>");viaHtml.push("</tr>")}viaHtml.push("</table>")}var divSta=BaseRoute._genTitle(this._results.getStart().title,\'Instance("\'+this.guid+\'")._select(0)\',0);var tables=["<table style=\'font:12px "+MapConfig.fontFamily+";border-collapse:collapse\' cellpadding=\'0\' cellspacing=\'0\' border=\'0\'>"]; var selIndex=0;for(var x=0,ct=plan.getNumRoutes();x<ct;x++){var route=plan.getRoute(x);for(var i=0,l=route.getNumSteps();i<l;i++){var bg="";if(this._curIndex==selIndex+1)bg=";background:#f0f0f0";tables.push(\'<tr style="cursor:pointer\'+bg+\'" onclick=\\\'Instance("\'+this.guid+\'")._select(\'+(selIndex+1)+")\'>");tables.push("<td style=\'border-bottom:1px solid #ccc;width:20px;vertical-align:top;text-align:right;padding:4px 3px\' >"+(selIndex+1)+".</td>");tables.push("<td style=\'border-bottom:1px solid #ccc;padding:2px;line-height:18px\' >"+ this._getCurStep(selIndex).getDescription()+"</td>");tables.push("</tr>");selIndex++}}tables.push("</table>");var divEnd=BaseRoute._genTitle(this._results.getEnd().title,\'Instance("\'+this.guid+\'")._select(\'+(selIndex+1)+")",1);var control="<div style=\'border-bottom:1px solid #ccc;margin-bottom:10px;color:#7777cc;background:#e5ecf9;"+"overflow:hidden;padding:2px;text-align:right\'><span style=\'float:left;padding-left:6px\'>\\u5168\\u7a0b\\uff1a"+plan.getDistance().replace(/(\\d+(?:.\\d+)?)/,"$1 ")+" / "+ plan.getDuration().replace(/(\\d+)/,"$1 ")+"</span>";if(this._results["moreResultsUrl"])control+="<a style=\'color:#7777cc\' href=\'"+this._results["moreResultsUrl"]+"\' target=\'_blank\'>\\u5230\\u767e\\u5ea6\\u5730\\u56fe\\u67e5\\u770b&#187;</a>";control+="&nbsp;</div>";container.innerHTML=title+viaHtml.join("")+divSta+tables.join("")+divEnd+control;this._opts.renderOptions.panel[TappendChild](container);this._triggerCbk(BaseSearch.CBK_RESULTS_HTML_SET,container)}},_getRoadName:function(roadType,roadName){if(roadName== ""||!roadName)if(roadType==9||roadType==12||roadType==1||roadType==16)roadName=DWRoute.ROAD_TYPE[roadType];return roadName},_getPoiInfo:function(rss){var tips="";var poi=rss["poi"];if(poi){var ps=this._getPsType(poi["ps"])||"",pw=this._getPwType(poi["pw"])||"";var ds=poi["pd"]<(rss.t==13||rss.t==4?1E3:50)?"":"\\u7ea6"+formatDistance(poi["pd"])+"\\u540e";tips=pw+ps+"<b>"+poi["pn"]+"</b>"+ds+(ps==""?"":"\\uff0c")}return tips},_getTicInfo:function(kps){var kiw=kps["iw"];return!kps["ic"]?"":(this._getIwGo(kiw)|| "")+"<b>"+kps["ic"]+"</b>"+(this._getIwTo(kiw)||"")},_getRoadAct:function(roadType,roadName){var act="\\u6cbf";if(roadType==0||!roadName&&roadType!=1&&roadType!=16&&roadType!=9&&roadType!=12)act="";return act},_getRetAct:function(roadType,roadName){var ret="\\u8fdb\\u5165";if(!roadName&&(roadType==9||roadType==12))ret="\\u4e0a";else if(roadType==0||!roadName&&roadType!=1&&roadType!=16)ret="";return ret},_getTaxiFare:function(){if(this._json&&this._json["content"]&&this._json["content"]["taxi"]){var taxiData= this._json["content"]["taxi"];var result={"distance":taxiData["dis"],"remark":taxiData["remark"]};if(taxiData["detail"][0]){var dayFare=taxiData["detail"][0];result["day"]={"initialFare":TparseFloat(dayFare["startPrice"]),"unitFare":TparseFloat(dayFare["kmPrice"]),"totalFare":TparseFloat(dayFare["totalPrice"])}}if(taxiData["detail"][1]){var nightFare=taxiData["detail"][1];result["night"]={"initialFare":TparseFloat(nightFare["startPrice"]),"unitFare":TparseFloat(nightFare["kmPrice"]),"totalFare":TparseFloat(nightFare["totalPrice"])}}return result}return null}});DrivingRoute.TURN_TYPE=["","\\u76f4\\u884c","\\u53f3\\u524d\\u65b9\\u8f6c\\u5f2f","\\u53f3\\u8f6c","\\u53f3\\u540e\\u65b9\\u8f6c\\u5f2f","\\u8c03\\u5934","\\u5de6\\u540e\\u65b9\\u8f6c\\u5f2f","\\u5de6\\u8f6c","\\u5de6\\u524d\\u65b9\\u8f6c\\u5f2f","\\u7a0d\\u5411\\u5de6\\u8f6c","\\u76f4\\u884c","\\u7a0d\\u5411\\u53f3\\u8f6c","\\u6b63\\u5317\\u65b9\\u5411","\\u4e1c\\u5317\\u65b9\\u5411","\\u6b63\\u4e1c\\u65b9\\u5411","\\u4e1c\\u5357\\u65b9\\u5411","\\u6b63\\u5357\\u65b9\\u5411","\\u897f\\u5357\\u65b9\\u5411","\\u6b63\\u897f\\u65b9\\u5411","\\u897f\\u5317\\u65b9\\u5411"]; DrivingRoute.RET_TYPE=["","\\u4ece\\u8d77\\u70b9\\u51fa\\u53d1","\\u5230\\u8fbe\\u76ee\\u7684\\u5730","\\u9014\\u7ecf\\u70b9","\\u884c\\u9a76"];DrivingRoute.IWGO=["\\u5728","\\u4ece","\\u4ece"];DrivingRoute.IWTO=["","","\\u79bb\\u5f00"];DrivingRoute.PWTYPE=["\\u8fc7","\\u5728"];DrivingRoute.PSTYPE=["\\u5de6\\u4fa7\\u7684","\\u53f3\\u4fa7\\u7684",""];DrivingRoute.DWTYPE=["","\\u671d"]; baidu[Textend](DrivingRoute[Tprototype],{_createResults:function(opts){return new DrivingRouteResult(opts)},_getTurnType:function(tt){return DrivingRoute.TURN_TYPE[tt]},_getRetType:function(rt){return DrivingRoute.RET_TYPE[rt]},_getIwGo:function(i){return DrivingRoute.IWGO[i]},_getIwTo:function(i){return DrivingRoute.IWTO[i]},_getPwType:function(i){return DrivingRoute.PWTYPE[i]},_getPsType:function(i){return DrivingRoute.PSTYPE[i]},_getDwType:function(i){return DrivingRoute.DWTYPE[i]}});WalkingRoute.TURN_TYPE=["","\\u76f4\\u8d70","\\u5411\\u53f3\\u524d\\u65b9\\u8f6c","\\u53f3\\u8f6c","\\u5411\\u53f3\\u540e\\u65b9\\u8f6c","\\u5411\\u540e\\u8f6c","\\u5411\\u5de6\\u540e\\u65b9\\u8f6c","\\u5de6\\u8f6c","\\u5411\\u5de6\\u524d\\u65b9\\u8f6c","\\u5de6\\u8f6c\\u7a7f\\u8fc7\\u9a6c\\u8def\\u5e76\\u7ee7\\u7eed\\u5411\\u524d","\\u53f3\\u8f6c\\u7a7f\\u8fc7\\u9a6c\\u8def\\u5e76\\u7ee7\\u7eed\\u5411\\u524d","\\u5de6\\u8f6c\\u7a7f\\u8fc7\\u9a6c\\u8def\\u5e76\\u5f80\\u56de\\u8d70","\\u53f3\\u8f6c\\u7a7f\\u8fc7\\u9a6c\\u8def\\u5e76\\u5f80\\u56de\\u8d70","\\u6b63\\u5317\\u65b9\\u5411", "\\u4e1c\\u5317\\u65b9\\u5411","\\u6b63\\u4e1c\\u65b9\\u5411","\\u4e1c\\u5357\\u65b9\\u5411","\\u6b63\\u5357\\u65b9\\u5411","\\u897f\\u5357\\u65b9\\u5411","\\u6b63\\u897f\\u65b9\\u5411","\\u897f\\u5317\\u65b9\\u5411","","","",""];WalkingRoute.RET_TYPE=["","\\u4ece\\u8d77\\u70b9\\u51fa\\u53d1","\\u5230\\u8fbe\\u76ee\\u7684\\u5730","\\u9014\\u7ecf\\u70b9","\\u8d70"];WalkingRoute.IWGO=["\\u5728","\\u4ece","\\u4ece"];WalkingRoute.IWTO=["","","\\u79bb\\u5f00"];WalkingRoute.PWTYPE=["\\u8fc7","\\u5728"]; WalkingRoute.PSTYPE=["\\u5de6\\u4fa7\\u7684","\\u53f3\\u4fa7\\u7684",""];WalkingRoute.DWTYPE=["","\\u671d"]; baidu[Textend](WalkingRoute[Tprototype],{_createResults:function(opts){delete opts.url;return new WalkingRouteResult(opts)},_getTurnType:function(tt){return WalkingRoute.TURN_TYPE[tt]},_getRetType:function(rt){return WalkingRoute.RET_TYPE[rt]},_getIwGo:function(i){return WalkingRoute.IWGO[i]},_getIwTo:function(i){return WalkingRoute.IWTO[i]},_getPwType:function(i){return WalkingRoute.PWTYPE[i]},_getPsType:function(i){return WalkingRoute.PSTYPE[i]},_getDwType:function(i){return WalkingRoute.DWTYPE[i]}}); ');
